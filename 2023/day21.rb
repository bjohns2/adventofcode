test_input = "...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
..........."

my_input = "...................................................................................................................................
........#..........#.#.....#......................#...#...#............#.#.....................#...##..#.........#...#.#...........
..............#...#.....#...##..........................#...............#..............#...#....#......#..#.#........#..#..........
...........#................................................................#..........#.....#.#......#........#...#...............
..#...#..#...........#....#...#...#....#.#...#.##........................#...#..#............#........#........#...................
....#...........#...........##.#.....#.....#...........#....................#.#.........#....#..................#...#..#....#......
.##..#.....#......#..#................#.#.##.................................#...............#........#..#..#...#............#.#...
...#.......##.#..........#.....#....##.......#.......................................................#.....##..#........#....#...#.
..#..........#....#........#..#.......#.......##..................#...............#.....#.......#.............#...#.....#..#.......
.............#......#.#..................#.#.......................##.#............#.........#...#.........#...............#..##...
....##..........#.................#............................##.....#.........#......#....#.............#..#.........#.........#.
......#....#.....#.......................#.#.....#.........#.........#..#............................#.........................#...
............#..#.............#..#....................................#............................#.#.#...................##.......
....#.....................#...#....#...##................#............##....................##.#............#.......#.......##.....
.....#....................#....#...........................................................#....#....#.....#.................#.....
..................................#.......#..................#........#.#...#...........#..#.............#..#.......#..##..........
...........#...........#..........#.......................##.......#...#...#..............................#.............#.....#....
..#.#..###...................................................#.#....##.........................#...................#..#....#.......
...........#..#....#........#..........................#.##....................................#.....#....##.......#.........#.....
..........#................#.#.......#............#.....#.#.....#......#...#................#...#..................#..........#....
......#...........#............#...#....##...........#.........#.........#..........................##.........#.......#...........
...#.#.............#..#........#.......................#..........#..............#.........#....#.........#...#.#..#.............#.
......#..#......#.#.#.................#..................................#...#....#.........#.#.#..............#.....#..#..#..#....
...#.......#.#..#..........#........#.#.........#.......#...#.....................#...........##..#.......#.......#................
...#...#.#..................#........#..............#...#....#.#.............#.......#...........................#......#..........
.....#......#.................................#.......#....#.........##.........................#...............#..........#...#...
..#......#..#........#.#........................#...#..#.#.....................#.#..#...........#.#............#...........#..##...
.#.....#.......#....#..........#.#............#..#.................#...........#..........................#...........#...#.#.#....
...................#........#.##............#..................#....##..#.#..............#............#......#..........#..........
....#........#...##............................#....#....#....#...............#.......................#...#........................
............#..................#.......#......#......#..............#.#..#.......#.................#...#....##...............#.....
..........#..........#..#.............##.#..........#..#................................................#................#.........
.....#..........#.......................#..........#..........................#......................#....................##.##.#..
..#............##......#.#............#...........................#..#............#........#.................#...........#.........
..............#...........#...........#........#........#.........#.........###.............#............#.#.......#...#..#........
...........#......................#......#............#..................#.......#.#.#.#..#..#.................................#...
.....#..#........................#..................#........................#..##.....#.#.....#.........................#.#.......
.........................................#........#.....#...........#.....#...#.....#...#.......#.........#.#......#...#........#..
....#....#...............................#.....#.......#.#...#....#......................#........##..............#.....#....#.....
.....#........#................#.....#...............#.............................#.........................#....#.#....#.#...#...
..............#..................##.....#..#.#.#...##...............................###............................#.#.##.#....#...
..##.........................#.......................................................#..........#...#.#.......#.......#....#.......
.##............#.#...........................#....#.....................##.......#..#.....##.....................#...#....#....#...
........#...................#........#...........#....#.....#......#..#.....#.........#.#.#.....#.....................##.......#...
.......................................#.#.................#..##........#.#........................................#..#...#..#.....
.........#....#............#...#...#......#...#.......#.....##....#......#..#..........#.#.......#........#........#........#..#...
...................................................#..........#.......#....#..............#..#...........#.........#..#..........#.
...........#...........#...#..#........#...#.................#....##......##..........##........#.....#...............#.......#....
...............................#..#............#.#..#.......#........#..##......#..#.................................#....##....#..
......#.....#.........#.....#.#.#..#..#..#......................#.#...#...#............#.##...#..............#.................#...
.#...................#...#......#..#.....#.....#........................##....#............#.......#.#........#....................
..........#...........................#..#..........#..#..............#...#..................#....#.........................#......
...#..#..............#..........#..#............#...........................#....................#.................................
........................#........#..##...............#.#......................##....##....#.........#..............................
......#...........#........#.................#............#............##.#............###....#................................#.#.
...#..............##.....................###.#.......#......#...#.#..........#.......#............##.##........##.#..........#..#..
......................#.#.#........#........#.#.#...#....#..........#.....#.....#.............#...###......#........#...........#..
.............#.#......###.....#.....##.....#.#...........#.#...................#..........#....##.........#....#................#..
....................#...#...#.....##.#..#.........#........#..............#.......#...#..#...#.....................................
..................#.......##.....#..........#................#.....#.#....#.........##.........##.......#.......#.#................
..................#.#...#....#............#......#..........#.##......#....#..............##........#..................#...........
.....................#.....#.#.........#......................#............#...........#..#...................#..#...#.............
.......#.....##.........#..#..............#.......................#................#..........#.#.......#..#..........#............
.............##..........#....#..........................#..###...#..#......###...##......##.#......#..#........#..................
.........#....#..#.....#....#...#.......#.....#.......................##..................##.#.....#.....................#.........
.................................................................S.................................................................
...........#...#....##..#..#................#.......#..#....#..#........#....................##.....#....#.................###.....
.........#...#..#....................#.......#....#...........#................................#................#.#..#.#...........
........................#.........#.#......#.#..............#.......##....................#.#..............#........#.#.#..........
...........#..#............#..##.....#...#..#..........#.......#.....#...............#..............#....#...........#...#.........
....................#..#...#.......#...#................#.........#....##.....#..##..........##.........#..#.#.##.###..............
................#..#...........................#..#........................................#...................#..#................
..#........................##.................#....................#.....#................#...........#.........#...#..............
.#.......................#..#...........##......#........................................#...............#.....................##..
.#...#..........#....#.....#.....#...#...#............#........................#.........#..#..................#...............##..
..................................#......#.......#.................................##..#..................#...#.............###....
.......#............#.......##..................#.#...............##....................#.........#...#....##...#.#................
...#...#..........##.#.........##.................#....#..................................#...#......##....#..............#........
.....#.....................##.......................#..#..................#..#.......#.....##..#.#....#.....##...............#.....
....#...............#.......#..........#.................#...............#..#........#.....#..............#......................#.
.#.#...#.....................................#.....#........#..........#..#..#....##.........#..............................#.#....
................................#...................#................#.#..........#.......#.....#...........................#..#.#.
.........................................#.#.#..........#...........#..............#.............#...........#...............#.....
.......#.............................#..#...#.......#.#..#.............#...#..................#........#...........................
..#...#.......................#...........#............#..............#.#............#.#..##.##.......................#..#.........
..........#...#...........##.........#.......##.............................#............#.........#....#.#..........#.........#...
............#.............................#................#..#....#....#.#.....#..........#.....#..#................#...........#.
...........#...................#.............................#.............#............................#....................#.....
................#.....................#.#...#..#.#.#...#....................#............#..##...................#...#........#..#.
....................#...............#..#.......#....#.........#...........#...#........#.........................#........#..##....
..#............##....#.......#..........#....#........#........#................................#.........................#..#.....
........#..........#.##............#.#....#.............#...........#.....#......#.......##.....#............#.#....#............#.
...#..................#..............#...........#.#...#...................#...#...................#..........##..#................
.........#.#.........#....................#..........#..........#..#.#.......................#.#..............#..................#.
........#..##...#.#.#...............#.......#..........................#.............#...................#.............##......#...
............#..#..#.....#...........#................................#....##......#............#.........#..........##..........#..
............#.......#....#.............##.#.......#...#.........................#...........#..............#...##................#.
....#.##.....#...#.........................#...#......#.#.#............#........#....................................#.............
..#.........#...................................#......#.............................#........................#....................
......##...#...........#................#..#..............#..##...............#.#......#.........................#....##...........
...#......#............................#..#.....#............##...........###..#....#..............#......................#........
.#...............#...................................#.......................#.......................#.............#...##.....#....
...........#........#.##...#...............##...#...........................#.....#......#.............................#..#......#.
..#..............#.....#.#.................#...#..........#........#..............................##.....#......#...#......#.....#.
.#.......................#...................#.#....##.....#...................................#....#.......................#......
..........#...........#.#........#.#.........#.......#.........#.............#........#.........#.#......#..............#...#....#.
..#...#.#........#......................................#..........#.#............................................#.......#........
.............#....#..............##.#..................#......#............#....#...............#..........#.......#.#....#...#....
...#.......#.......##.....#...#....#....................#.............#..#..........................#......................#.....#.
...#.......#.........#..#...............#.......................#.#..##.#.#...#...............#.#.#...........#..........#.........
.#....................#...#........#.............##......................##................#........#..................#.#..#......
..............#.#....................###.................#.....#..........##................#......##.#.#....#..........#..........
...........#...........#.......#...........#..........................#.....................#.......#.#.....#..........#.........#.
...........#..#..#...#.....................................#.#.............#.............#....#..##.........#..#....#.....#........
........##..#..#..............................................##......#....#..........#...................##..#.#...............#..
.....##..#..#.....#...............#.#.#..#................#...#.....#...#...#.........#.#....#..........#.................#........
..................#.#..............#........................##..#.......#.##......................#.........#.#.........#...#......
.#..#...................#.......................#.....................#.......................#...##...#.#....#...#......#.........
....#......#...#...........#..#...........#....#........................#............#.................................#...........
...#...............#..........#..........#....................##....#..#..............#.............#.....#....##....#.............
...##....#.##.....#..............#..#....#...............................................##........#....#.......#.......#......#...
.....................#....#.....#.....#..........#.............#................................#........##.........#..............
..........#..#.....#....#...............#......#..................#..............#........#...#.#........#.#.............#..#......
......#.........#.##........#..................#..............#...............#..##...#......#....#...#...#............#......#....
.#...........................................#.......#.............#......................##......#.....#..#.......................
.................#....##.......#.................#................................#......#.....#..#.........#...........##....#....
.#................................#...#......#....#...#............................#............#.....##...........................
....#....#.#.......#.......#.#.....#.........#.........#.................#...........#.....#...........#..#.......#................
.....................................#.....#....#...........................#..#.#..........#.#........#........#......#.....#.....
.#...#..........#..#.................#.............#.........................................................................##....
...................................................................................................................................
"

def parse_input(input)
  input.split("\n").map{|l| l.split('')}
end

def print_map(map, os)
  map.each_with_index do |line, i|
    new_line = line.map.with_index do |char, j|
      os.include?([i,j]) ? 'O' : char
    end
    puts new_line.join('')
  end
end

def find_start(map)
  map.each_with_index do |line, i|
    line.each_with_index do |char, j|
      return [i,j] if char == 'S'
    end
  end
end

def find_char_at_loc(map, i,j)
  line = i % map.size 
  col =  j % map[0].size
  map[line][col]
end

def step(map, os)
  new_os = []
  os.each do |o|
    up = find_char_at_loc(map, o[0]-1,o[1])
    new_os << [o[0]-1,o[1]] if up != '#'

    down = find_char_at_loc(map, o[0]+1,o[1])
    new_os << [o[0]+1,o[1]] if down != '#'

    left = find_char_at_loc(map, o[0],o[1]-1)
    # puts "left at #{o[0]},#{o[1]-1}: #{left}"
    new_os << [o[0], o[1]-1] if left != '#'

    right = find_char_at_loc(map, o[0],o[1]+1)
    # puts "right at #{o[0]},#{o[1]+1}: #{right}"

    new_os << [o[0], o[1]+1] if right != '#'
  end
  new_os
end

def solution(input)
  map = parse_input(input)

  start = find_start(map)

  os = [start]

  os_seen_twice_odd = []
  os_seen_twice_even = []
  (1..50).each do |i|
    os = step(map, os)

    doubles = os.select{|o| os.count(o) > 1}
    if i % 2 == 0
      os_seen_twice_even += doubles 
      os_seen_twice_even = os_seen_twice_even.uniq
      os_seen_twice_even.each{|double| os.delete(double)}

    else
      os_seen_twice_odd += doubles 
      os_seen_twice_odd = os_seen_twice_odd.uniq
      os_seen_twice_odd.each{|double| os.delete(double)}

    end

    puts "step #{i} has #{os.size} Os, #{os_seen_twice_odd.size} odds, #{os_seen_twice_even.size} evens" # if i%100 == 0 || i > 26501360
    puts "total on step #{i}: #{os.size + os_seen_twice_even.size}" if i%10 == 0 
    # puts os.map{|o| "[#{o[0]},#{o[1]}]"}.join(' ')
    # print_map(map, os)
  end
end

solution(test_input)
# 2, 4, 6, 9, 13, 16, 22, 30, 41, 50, 63, 74, 89
# +2  +2  +3  +4  +3  +8  +8  +11 +9 +13  +11 + 15